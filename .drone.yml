workspace:
  base: /go
  path: src/github.com/presslabs/titanium

pipeline:
  build-operator:
    image: golang:1.9
    commands:
      - go get -u github.com/golang/dep/cmd/dep
      - dep ensure
      - make
      - make test

  publish-operator:
    group: publish
    image: plugins/docker
    mirror: https://mirror.gcr.io
    registry: gcr.io
    repo: gcr.io/pl-infra/titanium-operator
    username: _json_key
    tags: ["${DRONE_BRANCH/master/latest}", "${DRONE_COMMIT_SHA:0:7}"]
    force_tag: true
    build_args:
      - release="${DRONE_COMMIT_SHA:0:7}"
    secrets:
      - source: GOOGLE_CREDENTIALS
        target: DOCKER_PASSWORD
    when:
      event: push

  publish-toolbox:
    group: publish
    image: plugins/docker
    mirror: https://mirror.gcr.io
    registry: gcr.io
    repo: gcr.io/pl-infra/titanium-toolbox
    dockerfile: toolbox/Dockerfile
    context: toolbox/
    username: _json_key
    tags: ["${DRONE_BRANCH/master/latest}", "${DRONE_COMMIT_SHA:0:7}"]
    force_tag: true
    build_args:
      - release="${DRONE_COMMIT_SHA:0:7}"
    secrets:
      - source: GOOGLE_CREDENTIALS
        target: DOCKER_PASSWORD
    when:
      event: push

  e2e-tests:
    image: gcr.io/pl-infra/kluster-toolbox:latest
    pull: true
    secrets:
      - GOOGLE_CREDENTIALS
      - GOOGLE_PROJECT_ID
      - TITANIUM_TEST_GS_CREDENTIALS
    environment:
      - TITANIUM_IMAGE_TAG=${DRONE_COMMIT_SHA:0:7}
      - OPERATOR_IMAGE=gcr.io/pl-infra/titanium-operator:${DRONE_COMMIT_SHA:0:7}
    commands:
      - kubectl config set-cluster e2e --server=http://minikube:4321
      - kubectl config set-context e2e --cluster=e2e
      - kubectl config use-context e2e
      - ./hack/e2e-tests/setup-minikube.sh
      - cd toolbox
      - pip3 install -r requirements.dev.txt
      - python3 -m pytest -v --capture=no

services:
  minikube:
    image: gcr.io/k8s-minikube/localkube-dind-image:v1.9.0
    privileged: true
    volumes:
      - /boot:/boot
      - /lib/modules:/lib/modules
      - /root/minikube:/var/lib/docker/aufs
    commands:
      - mkdir -p /var/log/localkube
      - touch /var/log/localkube/logs.txt
      - tail -f /var/log/localkube/logs.txt &
      - /start.sh
